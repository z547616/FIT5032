<template>
    <div class="mb-dashboard">
        <!-- È°∂ÈÉ®ÔºöÊ†áÈ¢ò + Âà∑Êñ∞ -->
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h5 class="mb-0">Admin Dashboard</h5>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" @click="loadAll" :disabled="loading">
                    <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
                    {{ loading ? 'Refreshing...' : 'Refresh' }}
                </button>
            </div>
        </div>

        <!-- ÂÖ≥ÈîÆÊåáÊ†áÂç°Áâá -->
        <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Users</div>
                                <div class="display-6 fw-bold">{{ kpis.users }}</div>
                            </div>
                            <i class="bi bi-people fs-2 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Posts</div>
                                <div class="display-6 fw-bold">{{ kpis.posts }}</div>
                            </div>
                            <i class="bi bi-chat-square-text fs-2 text-success"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Mood Entries</div>
                                <div class="display-6 fw-bold">{{ kpis.moods }}</div>
                            </div>
                            <i class="bi bi-activity fs-2 text-info"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Walks</div>
                                <div class="display-6 fw-bold">{{ kpis.walks }}</div>
                            </div>
                            <i class="bi bi-geo-alt fs-2 text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Likes (total)</div>
                                <div class="display-6 fw-bold">{{ kpis.likes }}</div>
                            </div>
                            <i class="bi bi-heart fs-2 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Comments (total)</div>
                                <div class="display-6 fw-bold">{{ kpis.comments }}</div>
                            </div>
                            <i class="bi bi-chat-dots fs-2 text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Mail Jobs (Running)</div>
                                <div class="display-6 fw-bold">{{ kpis.jobsRunning }}</div>
                            </div>
                            <i class="bi bi-send fs-2 text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-6 col-md-3">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <div class="text-muted small">Mail Jobs (Failed)</div>
                                <div class="display-6 fw-bold">{{ kpis.jobsFailed }}</div>
                            </div>
                            <i class="bi bi-exclamation-triangle fs-2 text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÊúÄËøëÂä®ÊÄÅÔºà3 ÂàóÂ∞èË°®Ôºâ -->
        <div class="row g-3">
            <div class="col-lg-4">
                <div class="card shadow-sm border-0 h-100 d-flex flex-column">
                    <div class="card-header bg-white d-flex align-items-center justify-content-between">
                        <strong>Recent Signups</strong>
                        <span class="small text-muted">last 5</span>
                    </div>

                    <div class="card-body pt-2 pb-0 flex-grow-1">
                        <div v-if="recent.users.length === 0" class="text-muted small">No new users.</div>
                        <ul v-else class="list-group list-group-flush">
                            <li v-for="u in recent.users" :key="u.id" class="list-group-item px-0">
                                <div class="fw-semibold">{{ u.username || '(no name)' }}</div>
                                <div class="small text-muted">{{ u.email || '-' }}</div>
                                <div class="small text-muted">{{ fmt(u.createdAt) }}</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white d-flex align-items-center justify-content-between">
                        <strong>Recent Posts</strong>
                        <span class="small text-muted">last 5</span>
                    </div>
                    <div class="card-body pt-2 pb-0">
                        <div v-if="recent.posts.length === 0" class="text-muted small">No posts yet.</div>
                        <ul class="list-group list-group-flush">
                            <li v-for="p in recent.posts" :key="p.id" class="list-group-item px-0">
                                <div class="fw-semibold text-truncate" :title="p.text || '(image only)'">
                                    {{ p.text || '(image only)' }}
                                </div>
                                <div class="small text-muted">
                                    by {{ p.username || 'User' }} ¬∑ ‚ù§Ô∏è {{ p.likeCount || 0 }} ¬∑ üí¨ {{ p.commentCount ||
                                    0 }}
                                </div>
                                <div class="small text-muted">{{ fmt(p.createdAt) }}</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-white d-flex align-items-center justify-content-between">
                        <strong>Recent Mail Jobs</strong>
                        <span class="small text-muted">last 5</span>
                    </div>
                    <div class="card-body pt-2 pb-0">
                        <div v-if="recent.jobs.length === 0" class="text-muted small">No jobs.</div>
                        <ul class="list-group list-group-flush">
                            <li v-for="j in recent.jobs" :key="j.id" class="list-group-item px-0">
                                <div class="fw-semibold text-truncate">{{ j.subject || '(No subject)' }}</div>
                                <div class="small">
                                    <span class="badge" :class="badgeClass(j.status)">{{ j.status }}</span>
                                    <span class="text-muted ms-2">{{ j.recipients?.length || 0 }} recipient(s)</span>
                                </div>
                                <div class="small text-muted">{{ fmt(j.createdAt) }}</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="err" class="text-danger small mt-3">{{ err }}</div>
    </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { db } from '../../firebase'
import {
  collection, collectionGroup, query, orderBy, limit as qLimit, getDocs,
  getCountFromServer, where
} from 'firebase/firestore'

/* -------- state -------- */
const loading = ref(false)
const err = ref('')
const kpis = ref({
  users: 0,
  posts: 0,
  moods: 0,
  walks: 0,
  likes: 0,
  comments: 0,
  jobsRunning: 0,
  jobsFailed: 0
})
const recent = ref({
  users: [],
  posts: [],
  jobs: []
})

/* -------- utils -------- */
/**
 * fmt(ts)
 * ÂäüËÉΩÔºöÂ∞Ü Firestore Timestamp/Date/Êó∂Èó¥ÂÄºÊ†ºÂºèÂåñ‰∏∫Êú¨Âú∞Êó∂Èó¥Â≠óÁ¨¶‰∏≤„ÄÇ
 * ÈÄªËæëËØ¥ÊòéÔºö
 * 1) ÂÖ•ÂèÇ‰∏∫Á©∫Áõ¥Êé•ËøîÂõûÁ©∫‰∏≤ÔºåÈÅøÂÖçÊ∏≤Êüì ‚ÄúInvalid Date‚Äù„ÄÇ
 * 2) Ëã•ÂØπË±°Â∏¶Êúâ toDate()ÔºàFirestore TimestampÔºâÔºåÂÖàËΩ¨Êàê DateÔºõÂê¶ÂàôÁî® new Date(ts)„ÄÇ
 * 3) ‰ΩøÁî® toLocaleString() ËæìÂá∫Êú¨Âú∞ÂåñÊó•ÊúüÊó∂Èó¥Ôºõ‰ªªÊÑèÂºÇÂ∏∏ÊçïËé∑ÂêéËøîÂõûÁ©∫‰∏≤Ôºå‰øùËØÅ UI Á®≥ÂÆö„ÄÇ
 */
function fmt(ts) {
  try {
    if (!ts) return ''
    const d = ts?.toDate ? ts.toDate() : new Date(ts)
    return d.toLocaleString()
  } catch { return '' }
}

/**
 * badgeClass(status)
 * ÂäüËÉΩÔºöÊ†πÊçÆ‰ªªÂä°Áä∂ÊÄÅËøîÂõûÂØπÂ∫îÁöÑ Bootstrap ËÉåÊôØÊ†∑ÂºèÁ±ª„ÄÇ
 * ÈÄªËæëËØ¥ÊòéÔºö
 * - Â∞Ü‰º†ÂÖ•ÁöÑÁä∂ÊÄÅÂ≠óÁ¨¶‰∏≤Â∞èÂÜôÂåñÔºõÊåâ success/partial/running/queued/failed ÂàÜÊîØËøîÂõû‰∏çÂêåÈÖçËâ≤Ôºõ
 * - Êú™Áü•Áä∂ÊÄÅÂõûÈÄÄ‰∏∫ÊµÖËâ≤ 'text-bg-light'ÔºåÁ°Æ‰øù‰∏ç‰ºöÂá∫Áé∞Êú™ÂÆö‰πâÊ†∑Âºè„ÄÇ
 */
function badgeClass(status) {
  switch ((status || '').toLowerCase()) {
    case 'success': return 'text-bg-success'
    case 'partial': return 'text-bg-warning'
    case 'running': return 'text-bg-primary'
    case 'queued':  return 'text-bg-secondary'
    case 'failed':  return 'text-bg-danger'
    default:        return 'text-bg-light'
  }
}

/* -------- loaders -------- */
/**
 * loadKPIs()
 * ÂäüËÉΩÔºöÊâπÈáèËé∑Âèñ‰ª™Ë°®ÁõòÂÖ≥ÈîÆÊåáÊ†áÔºàKPIÔºâÁöÑËÆ°Êï∞Êï∞ÊçÆ„ÄÇ
 * ÈÄªËæëËØ¥ÊòéÔºö
 * 1) ‰ΩøÁî® getCountFromServer ÂØπÂ§ö‰∏™ÈõÜÂêà/ÈõÜÂêàÁªÑÂπ∂Ë°åËÆ°Êï∞ÔºàPromise.allÔºâÔºåÈÅøÂÖçÂÖ®ÈáèÊãâÂèñÂ∏¶Êù•ÁöÑÊÄßËÉΩÂºÄÈîÄ„ÄÇ
 * 2) ÂØπ mail_jobs ‰ΩøÁî® where ËøáÊª§ÂàÜÂà´ÁªüËÆ° running/failed Êï∞Èáè„ÄÇ
 * 3) ËØªÂèñÂêÑËÅöÂêàÁªìÊûúÁöÑ countÔºåÊûÑÂª∫ kpis.valueÔºõËã•ÊüêÈ°πÁº∫Â§±ÂàôÂõûÈÄÄ‰∏∫ 0Ôºå‰øùËØÅÊòæÁ§∫Á®≥ÂÆö„ÄÇ
 */
async function loadKPIs() {
  // countsÔºàÂ∞ΩÈáèÁî® getCountFromServerÔºåÈÅøÂÖçÂÖ®ÈáèÊãâÂèñÔºâ
  const [
    usersAgg,
    postsAgg,
    moodsAgg,
    walksAgg,
    likesAgg,
    commentsAgg,
    jobsRunAgg,
    jobsFailAgg
  ] = await Promise.all([
    getCountFromServer(collection(db, 'users')),
    getCountFromServer(collection(db, 'posts')),
    getCountFromServer(collectionGroup(db, 'moodEntries')),
    getCountFromServer(collection(db, 'walks')),
    getCountFromServer(collectionGroup(db, 'likes')),
    getCountFromServer(collectionGroup(db, 'comments')),
    getCountFromServer(query(collection(db, 'mail_jobs'), where('status', '==', 'running'))),
    getCountFromServer(query(collection(db, 'mail_jobs'), where('status', '==', 'failed')))
  ])

  kpis.value = {
    users:       usersAgg.data().count || 0,
    posts:       postsAgg.data().count || 0,
    moods:       moodsAgg.data().count || 0,
    walks:       walksAgg.data().count || 0,
    likes:       likesAgg.data().count || 0,
    comments:    commentsAgg.data().count || 0,
    jobsRunning: jobsRunAgg.data().count || 0,
    jobsFailed:  jobsFailAgg.data().count || 0
  }
}

/**
 * loadRecent()
 * ÂäüËÉΩÔºöÂπ∂Ë°åËé∑ÂèñÊúÄËøë 5 Êù°ÁöÑ‚ÄúÊ≥®ÂÜåÁî®Êà∑ / Â∏ñÂ≠ê / ÈÇÆ‰ª∂‰ªªÂä°‚ÄùÂàóË°®ÔºåÁî®‰∫éÂè≥‰æßÊòéÁªÜÂç°Áâá„ÄÇ
 * ÈÄªËæëËØ¥ÊòéÔºö
 * 1) ÂØπ users/posts/mail_jobs Êåâ createdAt ÂÄíÂ∫èÊü•ËØ¢ÔºåÂπ∂ÈôêÂà∂ qLimit(5)„ÄÇ
 * 2) Â∞ÜÊü•ËØ¢Âø´ÁÖßÊò†Â∞Ñ‰∏∫ÊôÆÈÄöÂØπË±°Êï∞ÁªÑÔºàÈôÑÂä† idÔºâÔºåÂàÜÂà´Â°´ÂÖÖ recent.value ‰∏ãÁöÑ users/posts/jobs„ÄÇ
 * 3) Âπ∂ÂèëËØ∑Ê±ÇÂáèÂ∞ëÊï¥‰ΩìÁ≠âÂæÖÊó∂Èó¥ÔºåÊèêÂçáÈ¶ñÊ¨°Ê∏≤Êüì‰ΩìÈ™å„ÄÇ
 */
async function loadRecent() {
  const [usersSnap, postsSnap, jobsSnap] = await Promise.all([
    getDocs(query(collection(db, 'users'),     orderBy('createdAt', 'desc'), qLimit(5))),
    getDocs(query(collection(db, 'posts'),     orderBy('createdAt', 'desc'), qLimit(5))),
    getDocs(query(collection(db, 'mail_jobs'), orderBy('createdAt', 'desc'), qLimit(5)))
  ])

  recent.value.users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }))
  recent.value.posts = postsSnap.docs.map(d => ({ id: d.id, ...d.data() }))
  recent.value.jobs  = jobsSnap.docs.map(d => ({ id: d.id, ...d.data() }))
}

/**
 * loadAll()
 * ÂäüËÉΩÔºöÁªü‰∏ÄË∞ÉÂ∫¶Âä†ËΩΩ KPI ‰∏éÊúÄËøëÂàóË°®ÔºåÂπ∂Â§ÑÁêÜÂä†ËΩΩ/ÈîôËØØÁä∂ÊÄÅ„ÄÇ
 * ÈÄªËæëËØ¥ÊòéÔºö
 * 1) Â∞Ü loading ÁΩÆ‰∏∫ true„ÄÅÊ∏ÖÁ©∫ errÔºåËøõÂÖ•‚ÄúÂà∑Êñ∞‰∏≠‚ÄùÁä∂ÊÄÅÔºõ
 * 2) Âπ∂Ë°åË∞ÉÁî® loadKPIs ‰∏é loadRecentÔºå‰ªª‰ΩïÂºÇÂ∏∏ÈÉΩ‰ºöË¢´ÊçïËé∑Ôºö
 *    - ÊéßÂà∂Âè∞ËæìÂá∫ÈîôËØØÊó•ÂøóÔºõ
 *    - ËÆæÁΩÆÁî®Êà∑ÂèØËßÅÁöÑÈîôËØØÊ∂àÊÅØÔºåÊèêÁ§∫Ê£ÄÊü• Firestore ËßÑÂàô/Á¥¢ÂºïÔºõ
 * 3) finally ‰∏≠Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÈÉΩÂ∞Ü loading Â§ç‰Ωç‰∏∫ falseÔºå‰øùËØÅÊåâÈíÆ/È™®Êû∂Â±èÁ≠âÁä∂ÊÄÅÊ≠£Á°Æ„ÄÇ
 */
async function loadAll() {
  loading.value = true
  err.value = ''
  try {
    await Promise.all([loadKPIs(), loadRecent()])
  } catch (e) {
    console.error('[AdminDashboard] load error', e)
    err.value = 'Failed to load dashboard. Check Firestore rules & indexes.'
  } finally {
    loading.value = false
  }
}

/**
 * onMounted(loadAll)
 * ÂäüËÉΩÔºöÁªÑ‰ª∂ÊåÇËΩΩÂêéÁ´ãÂç≥ÊãâÂèñ‰ª™Ë°®ÁõòÊï∞ÊçÆÔºåÂÆåÊàêÈ¶ñÂ±èÊ∏≤Êüì„ÄÇ
 * ÈÄªËæëËØ¥ÊòéÔºö
 * - Áõ¥Êé•Ë∞ÉÁî®Â∞ÅË£ÖÂ•ΩÁöÑËÅöÂêàÂÖ•Âè£ loadAll()Ôºå‰ª•‰æøÂêåÊó∂Ëé∑Âèñ KPI ‰∏éÊúÄËøëÂä®ÊÄÅ„ÄÇ
 */
onMounted(loadAll)
</script>


<style scoped>
.mb-dashboard .list-group-item {
    background: transparent;
}
</style>
